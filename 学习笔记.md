## 服务远程调用RestTemplate

#### 问题说明：

目前有两个服务，需要实现order服务调用user服务，获取它的用户信息：

<img src="C:\Users\94816\AppData\Roaming\Typora\typora-user-images\image-20240404162937473.png" alt="image-20240404162937473" style="zoom:30%;" />

#### 实现方法：

1. **order服务中写一个@Bean：**

   ```java
   @Bean
       public RestTemplate restTemplate(){
           return new RestTemplate();
       }
   ```

   可以新建一个@Configuration，也可以直接再application中写，因为它本身也是一个@Configuration

2. **注入到需要user的controller，并通过getEntity获得用户信息**

   ```java
   @RestController
   @RequestMapping("order")
   public class OrderController {
   
      @Autowired
      private OrderService orderService;
      @Autowired
      private RestTemplate restTemplate;
   
       @GetMapping("{orderId}")
       public Order queryOrderByUserId(@PathVariable("orderId") Long orderId) {
           // 根据id查询订单并返回
           Order order=orderService.queryOrderById(orderId);
           String url="http://localhost:8081/user/"+order.getUserId();
           order.setUser(restTemplate.getForObject(url, User.class));
   
           return order;
       }
   }
   ```

   这里需要手动写好url（其中8081是user服务的端口号），且传入这一次get请求的相关参数。

#### 实现效果

通过访问order服务的`http://localhost:8080/order/{orderId}` ，可以得到包含user信息的结果，其中8080是order服务的端口号。



## 搭建Eureka服务

#### 创建并配置eureka-server

1. **new module：**

   <img src="C:\Users\94816\AppData\Roaming\Typora\typora-user-images\image-20240404163821524.png" alt="image-20240404163821524" style="zoom:50%;" />

2. **添加依赖**

   ```xml
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
           </dependency>
   ```

3. **启动类**

   ```java
   @EnableEurekaServer
   @SpringBootApplication
   public class EurekaApplication {
       public static void main(String[] args) {
           SpringApplication.run(EurekaApplication.class,args);
       }
   }
   ```

   相比于SpringBoot项目，这里还需要打开eureka的自动装配，所以需要`@EnableEurekaServer`。

4. **配置application**

   ```yml
   server:
     port: 12345
   
   spring:
     application:
       name: eureka-server
   eureka:
     client:
       service-url:
         defaultZone: http://127.0.0.1:12345/eureka
   
   ```

   配置server.port之前，需要查询一下端口是否已被占用：`netstat aon | findstr :12345`

   另外，补充说明以下端口号，端口号的范围是从1到65535。但是，并不是所有端口号都建议使用：

   1. **0-1023**: 这些是所谓的"知名端口"（Well-Known Ports），通常被操作系统或特定的系统服务占用。例如，HTTP服务通常使用端口80，HTTPS使用443。非管理员用户可能没有权限绑定这些端口。
   2. **1024-49151**: 这些是"注册端口"（Registered Ports），用于特定的服务。虽然有些端口在这个范围内是未被官方使用的，但最好避免使用常见的服务端口，比如MySQL默认端口3306，以避免冲突。
   3. **49152-65535**: 这些是"动态和/或私有端口"（Dynamic and/or Private Ports），通常用于临时通信端口。这些端口较少被系统服务占用，是为服务设定端口时的理想选择。

#### 实现效果

<img src="C:\Users\94816\AppData\Roaming\Typora\typora-user-images\image-20240404164736999.png" alt="image-20240404164736999" style="zoom:50%;" />

红色圈出来的是重点，代表已经在eureka注册的实例，目前还只有它自己被注册了，所以这里只有一个，它的名称就是我们在application中配置的名称`spring.application.name`。



## 实现Eureka服务注册

#### 将user和order服务添加到Eureka注册中心

1. **添加依赖**

   打开两个服务的pom文件，均添加依赖：

   ```xml
           <!--eureka客户端依赖-->
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
           </dependency>
   ```

   注意这里添加的是client，对于注册中心来说，所有的服务都是它的client，服务端和客户端的概念是相对的，这些服务对于用户来说是服务端，但是对于注册中心来说，是客户端，这里添加的依赖也是client。

2. **配置application文件**

   同样的，两个服务的application都要添加下述内容，注意spring配置的合并

   ```yml
   spring:
     application:
       name: user-service
   eureka:
     client:
       service-url:
         defaultZone: http://127.0.0.1:12345/eureka
   ```

   就是两个操作：命名和注册

#### 实现效果
刷新`http://localhost:12345/` ，可以看到：

![image-20240404184113600](C:\Users\94816\AppData\Roaming\Typora\typora-user-images\image-20240404184113600.png)

第一个是eureka注册中心本身，下面两个为本次添加的order和user两个服务。